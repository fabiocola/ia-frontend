<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orquestrador de IAs</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Estilos atualizados para suportar as novas funcionalidades */
        body, html { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; height: 100%; }
        #app { display: flex; width: 100%; height: 100%; }
        .sidebar { width: 260px; background-color: #202123; color: white; display: flex; flex-direction: column; padding: 10px; border-right: 1px solid #333; }
        .new-chat-btn { /* ... */ }
        .chat-history-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; cursor: pointer; border-radius: 5px; }
        .chat-history-item:hover { background-color: #343541; }
        .chat-history-item.active { background-color: #444654; }
        .chat-title { flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-actions button { background: none; border: none; color: #aaa; cursor: pointer; visibility: hidden; }
        .chat-history-item:hover .chat-actions button { visibility: visible; }
        /* ... (outros estilos ) ... */
    </style>
</head>
<body>
    <div id="app">
        <div class="sidebar">
            <h2>Conversas</h2>
            <div class="new-chat-btn" @click="startNewConversation">Nova Conversa (+)</div>
            <div class="chat-history">
                <div v-for="chatItem in chatHistory" :key="chatItem.id" class="chat-history-item" :class="{ 'active': activeChatId === chatItem.id }" @click="loadChat(chatItem.id)">
                    <span class="chat-title" @dblclick="startEditingTitle(chatItem)" v-if="!chatItem.editing">{{ chatItem.title }}</span>
                    <input v-if="chatItem.editing" type="text" v-model="chatItem.newTitle" @blur="saveTitle(chatItem)" @keydown.enter="saveTitle(chatItem)" @keydown.esc="cancelEditing(chatItem)">
                    <div class="chat-actions">
                        <button @click.stop="startEditingTitle(chatItem)">‚úèÔ∏è</button>
                        <button @click.stop="deleteChat(chatItem.id)">üóëÔ∏è</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- O resto do HTML (main-content, etc.) -->
    </div>

    <script>
        const { createApp } = Vue;
        createApp({
            data() { /* ... */ },
            mounted() { /* ... */ },
            methods: {
                startNewConversation() {
                    this.activeChatId = null;
                    this.activeChatMessages = [];
                    // Opcional: pode limpar os arquivos selecionados tamb√©m
                },
                async sendMessage() {
                    if (!this.newMessage.trim() || this.isLoading) return;

                    let currentChatId = this.activeChatId;

                    // **L√ìGICA DE IN√çCIO IMPL√çCITO**
                    if (currentChatId === null) {
                        try {
                            const response = await fetch(`${this.apiUrl}/chats`, { method: 'POST' });
                            const newChat = await response.json();
                            this.chatHistory.unshift(newChat);
                            currentChatId = newChat.id;
                            this.activeChatId = newChat.id;
                        } catch (error) {
                            // Lidar com erro de cria√ß√£o de chat
                            return;
                        }
                    }
                    
                    // ... (resto da l√≥gica de envio, usando currentChatId) ...
                    
                    // Ap√≥s receber a resposta, se for uma conversa nova, atualiza o t√≠tulo
                    if (this.activeChatMessages.length === 2) { // 1 do user, 1 do assistant
                        this.loadChatHistory(); // Recarrega o hist√≥rico para pegar o novo t√≠tulo
                    }
                },
                startEditingTitle(chatItem) {
                    this.chatHistory.forEach(c => c.editing = false); // Garante que s√≥ um est√° sendo editado
                    chatItem.newTitle = chatItem.title;
                    chatItem.editing = true;
                },
                cancelEditing(chatItem) {
                    chatItem.editing = false;
                },
                async saveTitle(chatItem) {
                    if (!chatItem.newTitle.trim()) return;
                    try {
                        await fetch(`${this.apiUrl}/chats/${chatItem.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ title: chatItem.newTitle })
                        });
                        chatItem.title = chatItem.newTitle;
                        chatItem.editing = false;
                    } catch (error) {
                        console.error("Erro ao renomear:", error);
                    }
                },
                async deleteChat(chatId) {
                    if (!confirm("Tem certeza que deseja apagar esta conversa?")) return;
                    try {
                        await fetch(`${this.apiUrl}/chats/${chatId}`, { method: 'DELETE' });
                        this.chatHistory = this.chatHistory.filter(c => c.id !== chatId);
                        if (this.activeChatId === chatId) {
                            this.startNewConversation();
                        }
                    } catch (error) {
                        console.error("Erro ao apagar:", error);
                    }
                },
                // ... (outros m√©todos) ...
            }
        }).mount('#app');
    </script>
</body>
</html>